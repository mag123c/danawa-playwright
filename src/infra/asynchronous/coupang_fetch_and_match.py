import asyncio
from urllib.parse import quote
from playwright.async_api import async_playwright
from src.parser.asynchronous.coupang_product_parser import CoupangProductParser
from src.service.coupang_product_matcher import CoupangProductMatcher
# from src.service.affiliate_link_generator import AffiliateLinkGenerator


class CoupangHtmlFetcher:
    BASE_URL = "https://www.coupang.com/np/search?q="

    def __init__(self, keyword: str):
        self.keyword = keyword

    async def fetch_html(self) -> str:
        async with async_playwright() as p:
            browser = await p.chromium.launch(headless=True, args=['--disable-web-security'])
            context = await browser.new_context(ignore_https_errors=True)
            api_request = context.request

            encoded = quote(self.keyword)
            url = f"{self.BASE_URL}{encoded}"
            print(f"ğŸ” ìš”ì²­ URL: {url}")

            response = await api_request.get(
                url,
                timeout=60000,
                headers={
                    "Host": "www.coupang.com",
                    "Accept": "*/*",
                    "Accept-Encoding": "gzip, deflate, br, zstd",
                    "Accept-Language": "ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7",
                    "Content-Type": "text/plain",
                    "Origin": "https://www.coupang.com",
                    "Referer": "https://www.coupang.com/",
                    "Sec-CH-UA": '"Google Chrome";v="135", "Not-A.Brand";v="8", "Chromium";v="135"',
                    "Sec-CH-UA-Mobile": "?0",
                    "Sec-CH-UA-Platform": '"macOS"',
                    "Sec-Fetch-Dest": "empty",
                    "Sec-Fetch-Mode": "cors",
                    "Sec-Fetch-Site": "same-site",
                    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36",
                    "Priority": "u=1, i"
                }
            )

            html = await response.text()
            print(f"ğŸ“„ HTML ê¸¸ì´: {len(html)}")

            await browser.close()
            return html   



async def main():
    keyword = "ì˜¬ë¦¬ë¹™ ë„íŠ¸ ì•„ì´ìŠ¤ë°•ìŠ¤ 21L ë¯¼íŠ¸"
    html = await CoupangHtmlFetcher(keyword).fetch_html()

    products = CoupangProductParser.parse_products(html)
    if not products:
        print("âŒ ì‹¤ì œ ìƒí’ˆì´ í•˜ë‚˜ë„ ì—†ìŠµë‹ˆë‹¤.")
        return

    matcher = CoupangProductMatcher(target_name=keyword)
    best = matcher.find_best_match(products)
    if not best:
        print("âŒ ìœ ì‚¬ë„ê°€ ê¸°ì¤€ ì´í•˜ì¸ ìƒí’ˆë§Œ ìˆìŠµë‹ˆë‹¤.")
        return

    print(f"ğŸ¯ ë§¤ì¹­ ìƒí’ˆ: {best}")
    print(f"https://www.coupang.com/vp/products/{best.product_id}?itemId={best.item_id}&vendorItemId={best.vendor_item_id}")

    # gen = AffiliateLinkGenerator("YOUR_AFFILIATE_ID")
    # link = gen.generate(best)
    # print(f"âœ… ë§¤ì¹­ëœ ìƒí’ˆ: {best}")
    # print(f"ğŸ”— ì–´í•„ë¦¬ì—ì´íŠ¸ ë§í¬: {link}")


if __name__ == "__main__":
    asyncio.run(main())